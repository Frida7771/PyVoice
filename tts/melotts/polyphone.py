"""
多音字消歧模块

根据上下文自动选择正确的多音字读音
"""
import re
from typing import Optional, Dict, List, Tuple


# 多音字规则表
# 格式: 字 -> [(匹配模式, 拼音), ...] 最后一个 "default" 为默认读音
# 拼音格式: 声母+韵母+声调数字 (如 zhang3 = zhǎng)
POLYPHONE_RULES: Dict[str, List[Tuple[str, str]]] = {
    # ===== 高频多音字 =====
    "长": [
        (r"长大|成长|长高|长辈|长子|长女|长兄|长姐|生长|增长|长进|长膘|长肉|长胖|长个", "zhang3"),
        ("default", "chang2"),  # 长度、长短
    ],
    "行": [
        (r"银行|行业|行长|央行|商行|分行|支行|行情|行市|同行|内行|外行|在行|行家|行当|行话|行规", "hang2"),
        (r"行列|行伍|字行|单行|双行", "hang2"),
        ("default", "xing2"),  # 行走、行动
    ],
    "重": [
        (r"重复|重新|重来|重做|重建|重写|重启|重置|重装|重试|重审|重申|重现|重演|重播|重返|重逢|重归|重游|重温|重拾|重提|重整|重组|重塑|双重|多重", "chong2"),
        ("default", "zhong4"),  # 重量、重要
    ],
    "还": [
        (r"归还|偿还|返还|退还|交还|送还|还款|还钱|还债|还贷|还清|还本|还原|还礼|还击|还手|还嘴|还价", "huan2"),
        ("default", "hai2"),  # 还是、还有
    ],
    "乐": [
        (r"音乐|乐器|乐曲|乐章|乐团|乐队|乐手|乐坛|乐谱|乐理|乐感|乐律|民乐|声乐|器乐|交响乐|摇滚乐|古典乐|流行乐", "yue4"),
        ("default", "le4"),  # 快乐、乐意
    ],
    "了": [
        (r"了解|了然|了却|了结|了断|了事|了得|了不起|一目了然|不甚了了", "liao3"),
        ("default", "le5"),  # 完成态助词
    ],
    "得": [
        (r"得到|获得|取得|赢得|博得|值得|懂得|记得|舍得|觉得|显得|免得|省得|难得|使得|落得|晓得", "de2"),
        (r"得亏|得劲|得空|得闲", "dei3"),
        ("default", "de5"),  # 结构助词：跑得快
    ],
    "地": [
        (r"地方|地点|地址|地区|地带|地域|地段|地块|地皮|地基|地面|地板|地砖|地毯|地下|地上|土地|陆地|大地|天地|本地|当地|外地|异地|各地|遍地|落地|着地|接地|占地|用地|耕地|荒地|空地|场地|阵地|基地|领地|属地|殖民地|地产|地租|地税|地主|地头|地势|地形|地貌|地质|地层|地壳|地幔|地核|地球|地图|地理|地名|地标|地震|地热|地磁|地雷|地道|地铁|地窖|地洞|地牢|地狱", "di4"),
        ("default", "de5"),  # 结构助词：慢慢地走
    ],
    "数": [
        (r"数据|数字|数量|数目|数值|数额|数码|数学|数理|数列|数组|数论|数轴|数位|数倍|分数|小数|整数|负数|正数|奇数|偶数|质数|素数|有理数|无理数|实数|虚数|复数|代数|函数|常数|变数|参数|系数|指数|幂数|对数|级数|基数|序数|余数|约数|倍数|因数|被除数|除数|商数|个数|人数|次数|岁数|年数|天数|字数|页数|招数|命数|气数|定数|变数|未知数", "shu4"),
        (r"数一数|数数|数钱|数人|清点数|倒数|细数|历数|如数|屈指可数|不可胜数|数不清|数不胜数", "shu3"),
        ("default", "shu4"),
    ],
    "发": [
        (r"头发|毛发|理发|美发|染发|烫发|卷发|直发|长发|短发|秀发|黑发|白发|金发|银发|假发|脱发|掉发|生发|护发|洗发|吹发|发型|发式|发丝|发梢|发根|发际|发廊|发屋|发胶|发蜡|发油|发夹|发卡|发带|发箍|发网|发饰|结发|束发|披发|散发|鬓发|须发|毫发", "fa4"),
        ("default", "fa1"),  # 发展、发生
    ],
    "差": [
        (r"差别|差距|差异|差额|差价|差错|差评|误差|偏差|落差|温差|时差|色差|相差|差不多|差一点|差得远", "cha1"),
        (r"出差|差遣|差事|差使|差役|公差|钦差|听差|当差", "chai1"),
        (r"参差", "ci1"),
        ("default", "cha4"),  # 差劲
    ],
    "调": [
        (r"调查|调解|调节|调整|调控|调配|调度|调动|调换|调拨|调遣|调派|调任|调离|调走|调来|调去|调入|调出|调回|调职|调岗|调班|调课|调休|调价|调档|协调|转调|对调|微调|空调", "tiao2"),
        (r"调子|音调|声调|语调|腔调|曲调|格调|论调|笔调|基调|色调|情调|单调|高调|低调|强调|跑调|走调|定调|变调|转调", "diao4"),
        ("default", "tiao2"),
    ],
    "划": [
        (r"划算|划得来|划不来|划拳|划船|划桨|划水|划艇|划龙舟", "hua2"),
        (r"计划|规划|策划|筹划|谋划|企划|划分|划定|划界|划线|划时代|划清|划归|划拨", "hua4"),
        ("default", "hua4"),
    ],
    "处": [
        (r"处理|处置|处分|处罚|处决|处死|处方|处境|处于|处在|处世|处事|处变|处乱|处之泰然|相处|共处|和平共处|独处|自处|身处|设身处地|养尊处优", "chu3"),
        (r"处所|处处|到处|各处|四处|何处|别处|他处|随处|住处|去处|来处|出处|用处|好处|坏处|益处|害处|长处|短处|妙处|深处|高处|远处|近处|暗处|明处|实处|难处|痛处|痒处|伤处|患处", "chu4"),
        ("default", "chu3"),
    ],
    "当": [
        (r"当铺|当票|典当|质当|赎当|抵当", "dang4"),
        ("default", "dang1"),  # 当时、应当
    ],
    "传": [
        (r"传记|自传|外传|列传|小传|正传|别传|评传|传奇|传说|经传|《.*传》", "zhuan4"),
        ("default", "chuan2"),  # 传递、传播
    ],
    "宿": [
        (r"星宿|二十八宿", "xiu4"),
        (r"一宿|两宿|三宿|住一宿|过一宿|整宿", "xiu3"),
        ("default", "su4"),  # 住宿、宿舍
    ],
    "藏": [
        (r"西藏|藏族|藏语|藏文|藏医|藏药|藏传|藏历|藏戏|藏獒|藏羚羊|藏红花|青藏|川藏|滇藏|新藏|藏区|藏民|藏胞|雪域藏地", "zang4"),
        ("default", "cang2"),  # 隐藏、收藏
    ],
    "弹": [
        (r"子弹|炮弹|炸弹|导弹|核弹|氢弹|原子弹|手榴弹|燃烧弹|烟雾弹|催泪弹|照明弹|信号弹|曳光弹|穿甲弹|高爆弹|榴弹|霰弹|枪弹|实弹|空弹|弹头|弹壳|弹匣|弹夹|弹药|弹片|弹孔|弹道|弹坑|弹痕|中弹|挨弹|吃弹|饮弹|弹尽粮绝", "dan4"),
        ("default", "tan2"),  # 弹琴、弹奏
    ],
    "薄": [
        (r"薄荷|薄饼", "bo4"),
        (r"厚薄|单薄|稀薄|浅薄|淡薄|微薄|鄙薄|菲薄|刻薄|轻薄|尖酸刻薄|日薄西山|势单力薄", "bo2"),
        ("default", "bao2"),  # 薄片、薄纸
    ],
    "曾": [
        (r"曾经|未曾|何曾|不曾|曾几何时|曾几", "ceng2"),
        ("default", "zeng1"),  # 姓曾、曾孙
    ],
    "朝": [
        (r"朝代|朝廷|朝政|朝野|朝堂|朝臣|朝贡|朝拜|朝圣|朝见|朝觐|王朝|皇朝|朝鲜|今朝|明朝|清朝|唐朝|宋朝|元朝|汉朝|周朝|秦朝|隋朝|三朝元老|朝三暮四|朝思暮想|朝令夕改|朝秦暮楚|朝气蓬勃|一朝一夕|改朝换代", "chao2"),
        ("default", "zhao1"),  # 朝阳、朝向
    ],
    "的": [
        (r"的确|的当|的士|打的|目的|有的放矢|众矢之的", "di4"),
        ("default", "de5"),  # 结构助词
    ],
    "度": [
        (r"度过|欢度|虚度|度日|度假|度蜜月|度年如日|安度晚年|普度众生|超度", "du4"),
        (r"揣度|猜度|忖度|审度|测度", "duo2"),
        ("default", "du4"),  # 温度、角度
    ],
    "干": [
        (r"干部|干事|干将|干练|干才|才干|骨干|躯干|主干|树干|枝干|干线|干道|干流|干渠|干细胞|若干|栏干|勾干", "gan4"),
        ("default", "gan1"),  # 干燥、干净
    ],
    "给": [
        (r"给予|给养|补给|供给|配给|自给自足|家给人足", "ji3"),
        ("default", "gei3"),  # 给你
    ],
    "会": [
        (r"会计|财会", "kuai4"),
        ("default", "hui4"),  # 会议、开会
    ],
    "间": [
        (r"间谍|间断|间隔|间隙|间歇|间接|间或|间作|离间|挑拨离间|反间计", "jian4"),
        ("default", "jian1"),  # 房间、时间
    ],
    "将": [
        (r"将军|将领|将帅|将士|将门|上将|中将|少将|大将|名将|虎将|悍将|骁将|老将|宿将|健将|干将|武将|战将|主将|副将|参将|守将|败将|降将|将星|将才|将相|将官|将校|将令|点将|拜将|调兵遣将|损兵折将|兵来将挡|过关斩将", "jiang4"),
        ("default", "jiang1"),  # 将来、将要
    ],
    "教": [
        (r"教书|教课|教学|教授|教师|教员|教官|教练|教导|教诲|教育|教养|教化|教唆|教训|教程|教材|教案|教室|教堂|教会|教派|教规|教义|教徒|教主|教父|教母|宗教|佛教|道教|基督教|天主教|伊斯兰教|言传身教|因材施教|有教无类|谆谆教诲", "jiao4"),
        (r"教给|教会了|教懂了", "jiao1"),
        ("default", "jiao4"),
    ],
    "觉": [
        (r"觉得|觉察|觉悟|觉醒|觉知|感觉|知觉|视觉|听觉|触觉|味觉|嗅觉|幻觉|错觉|直觉|自觉|警觉|察觉|发觉|惊觉|不知不觉|后知后觉|先知先觉", "jue2"),
        ("default", "jiao4"),  # 睡觉
    ],
    "看": [
        (r"看守|看护|看管|看门|看家|看押|看住|看好|看紧", "kan1"),
        ("default", "kan4"),  # 看见
    ],
    "空": [
        (r"空白|空隙|空缺|空闲|空余|空档|有空|没空|抽空|得空|腾空|填空|留空|落空", "kong4"),
        ("default", "kong1"),  # 空气、天空
    ],
    "乘": [
        (r"史乘|千乘之国|万乘之尊", "sheng4"),
        ("default", "cheng2"),  # 乘坐
    ],
    "累": [
        (r"累计|累积|累加|累进|日积月累|危如累卵|果实累累|硕果累累|罪行累累|连篇累牍", "lei3"),
        (r"劳累|疲累|受累|连累|拖累|牵累", "lei4"),
        ("default", "lei4"),  # 很累
    ],
    "量": [
        (r"量词|量杯|量筒|量角器|测量|丈量|衡量|估量|掂量|打量|思量|商量|酌量|度量|考量|权衡", "liang2"),
        ("default", "liang4"),  # 数量、质量
    ],
    "露": [
        (r"露水|露珠|露天|露营|白露|寒露|甘露|雨露|朝露", "lu4"),
        (r"露面|露脸|露相|露馅|露怯|露丑|露富|露底|露骨|暴露|揭露|披露|透露|流露|吐露|显露|袒露|裸露|崭露|崭露头角|锋芒毕露|原形毕露|不露声色|藏头露尾|抛头露面|出乖露丑", "lou4"),
        ("default", "lu4"),
    ],
    "落": [
        (r"落下|落后|落空|落选|落榜|落第|落败|落马|落网|落难|落魄|落伍|落寞|落寂|落泪|落款|落户|落座|落定|落实|落成|落幕|落日|落叶|落花|落雨|落雪|落潮|陨落|坠落|降落|滑落|跌落|掉落|倒落|垂落|飘落|散落|零落|冷落|没落|沦落|衰落|堕落|失落|遗落|落入|落到|落在|下落|落地|落脚|落户|着落|部落|村落|聚落|院落|角落|段落|落差|落点|大起大落|七零八落|丢三落四", "luo4"),
        (r"落枕|落色|落价", "lao4"),
        ("default", "luo4"),
    ],
    "模": [
        (r"模样|模子|装模作样|大模大样|人模狗样|一模一样", "mu2"),
        ("default", "mo2"),  # 模型、模式
    ],
    "难": [
        (r"难民|难友|难胞|难兄难弟|逃难|避难|受难|遇难|罹难|殉难|患难|苦难|灾难|劫难|厄难|磨难|国难|海难|空难|遭难", "nan4"),
        ("default", "nan2"),  # 困难、难以
    ],
    "宁": [
        (r"宁愿|宁可|宁肯|宁死|宁缺毋滥|宁死不屈|宁为玉碎|宁折不弯|毋宁", "ning4"),
        ("default", "ning2"),  # 安宁
    ],
    "迫": [
        (r"迫击炮", "pai3"),
        ("default", "po4"),  # 迫切
    ],
    "强": [
        (r"强迫|勉强|强人所难|强词夺理|强颜欢笑|强弩之末|牵强附会", "qiang3"),
        (r"倔强", "jiang4"),
        ("default", "qiang2"),  # 强大
    ],
    "亲": [
        (r"亲家", "qing4"),
        ("default", "qin1"),  # 亲人
    ],
    "撒": [
        (r"撒谎|撒娇|撒野|撒泼|撒欢|撒气|撒手|撒腿|撒尿", "sa1"),
        ("default", "sa3"),  # 撒种
    ],
    "丧": [
        (r"丧事|丧礼|丧葬|丧服|丧钟|丧期|丧假|丧家|丧偶|丧父|丧母|丧亲|丧子|奔丧|治丧|办丧|报丧|吊丧|哭丧|居丧|守丧|服丧|出丧|送丧|发丧|国丧|丧命|丧生|丧亡", "sang1"),
        ("default", "sang4"),  # 丧失
    ],
    "舍": [
        (r"宿舍|校舍|寒舍|农舍|茅舍|田舍|旅舍|旅舍|客舍|房舍|庐舍|屋舍|居舍|馆舍|舍下|舍间|舍亲|舍弟|舍妹|舍侄", "she4"),
        ("default", "she3"),  # 舍得、舍弃
    ],
    "省": [
        (r"反省|省察|省悟|省视|自省|内省|三省吾身|不省人事|发人深省", "xing3"),
        ("default", "sheng3"),  # 省份
    ],
    "什": [
        (r"什锦|什物|家什", "shi2"),
        ("default", "shen2"),  # 什么
    ],
    "识": [
        (r"标识|博闻强识", "zhi4"),
        ("default", "shi2"),  # 认识
    ],
    "似": [
        (r"似的", "shi4"),
        ("default", "si4"),  # 相似
    ],
    "说": [
        (r"说服|游说", "shui4"),
        ("default", "shuo1"),  # 说话
    ],
    "鲜": [
        (r"鲜见|鲜有|鲜为人知|屡见不鲜|寡廉鲜耻|数见不鲜", "xian3"),
        ("default", "xian1"),  # 新鲜
    ],
    "相": [
        (r"相貌|相片|相册|相框|相机|相纸|照相|拍相|看相|面相|手相|骨相|福相|官相|穷相|丑相|吃相|睡相|站相|坐相|走相|样相|真相|假相|实相|表相|外相|内相|万相|众生相|露相|显相|变相|亮相|长相|相好|相公|相国|宰相|首相|丞相|辅相|相亲|相面", "xiang4"),
        ("default", "xiang1"),  # 相互、相信
    ],
    "校": [
        (r"校对|校正|校准|校验|校勘|校阅|校订|校改|校注|校样|校稿|校核", "jiao4"),
        ("default", "xiao4"),  # 学校
    ],
    "血": [
        (r"血淋淋|流了点血|吐了口血|咳血|呕血|便血|尿血|吐血|流血|出血|献血|抽血|输血|验血|化验血|血水|血污|血迹|血渍|血块|血泡|血泪", "xie3"),
        ("default", "xue4"),  # 血液
    ],
    "压": [
        (r"压根儿|压根", "ya4"),
        ("default", "ya1"),  # 压力
    ],
    "要": [
        (r"要求|要素|要点|要领|要义|要旨|要诀|要害|要塞|要道|要冲|要地|要职|要员|要人|要案|要事|要务|要闻|要价|要挟|紧要|重要|主要|次要|首要|必要|需要|概要|纲要|摘要|提要|简要|扼要", "yao4"),
        (r"要是|只要|要么|要不|要不是|要不然|要强|要脸|要好|要命|要死|要紧|不要紧", "yao4"),
        ("default", "yao4"),
    ],
    "应": [
        (r"应该|应当|应有|应得|应付|应对|应战|应试|应聘|应征|应邀|应约|应诊|应急|应变|应酬|应承|应允|应诺|应声|应和|应答|应验|应用|应景|应时|适应|顺应|响应|反应|呼应|感应|效应|回应|对应|相应|供应", "ying4"),
        ("default", "ying1"),  # 应当（书面）
    ],
    "与": [
        (r"参与", "yu4"),
        ("default", "yu3"),  # 与其
    ],
    "扎": [
        (r"扎实|扎根|扎营|扎寨|驻扎|安扎", "zha1"),
        (r"挣扎|垂死挣扎", "zha2"),
        ("default", "za1"),  # 扎辫子
    ],
    "择": [
        (r"择菜", "zhai2"),
        ("default", "ze2"),  # 选择
    ],
    "炸": [
        (r"炸弹|炸药|炸毁|炸裂|炸开|爆炸|轰炸|炸掉|炸死|炸伤|引爆|自爆", "zha4"),
        ("default", "zha2"),  # 油炸
    ],
    "中": [
        (r"中奖|中标|中签|中选|中招|中计|中毒|中暑|中风|中弹|中枪|猜中|说中|命中|击中|打中|射中|看中|选中|相中|投中|踢中|砸中", "zhong4"),
        ("default", "zhong1"),  # 中国、中间
    ],
    "种": [
        (r"种植|种地|种田|种菜|种花|种树|种草|种瓜|种豆|播种|栽种|耕种|种子选手", "zhong4"),
        ("default", "zhong3"),  # 种类、品种
    ],
    "轧": [
        (r"轧钢|轧机|热轧|冷轧|轧辊", "zha2"),
        ("default", "ya4"),  # 倾轧
    ],
    "着": [
        (r"着急|着迷|着凉|着火|着魔|着慌|着忙|着想|着重|着眼|着手|着力|着落|着陆|着床|着色|着墨|着笔|着意|着实|沉着|执着|依着|顺着|照着|接着|跟着|随着", "zhuo2"),
        (r"着呢", "zhe5"),
        (r"睡着|着了", "zhao2"),
        ("default", "zhe5"),  # 看着、走着
    ],
    "只": [
        (r"只身|只言片语|只字|形单影只|片纸只字|只影|只手遮天|只鳞片爪", "zhi1"),
        ("default", "zhi3"),  # 只有、只是
    ],
}


def resolve_polyphone(text: str, char: str, position: int) -> Optional[str]:
    """
    根据上下文解决多音字读音
    
    Args:
        text: 完整文本
        char: 要消歧的多音字
        position: 该字在文本中的位置
    
    Returns:
        正确的拼音（如 "zhang3"），如果不是多音字或无法消歧则返回 None
    """
    if char not in POLYPHONE_RULES:
        return None
    
    rules = POLYPHONE_RULES[char]
    
    # 扩展上下文范围（前后各取4个字符）
    context_start = max(0, position - 4)
    context_end = min(len(text), position + 5)
    context = text[context_start:context_end]
    
    # 遍历规则
    for pattern, pinyin in rules:
        if pattern == "default":
            return pinyin
        if re.search(pattern, context):
            return pinyin
    
    return None


def get_polyphone_pinyin(text: str, char: str, position: int) -> Optional[str]:
    """
    获取多音字的拼音（供 G2P 查表时使用）
    
    Args:
        text: 完整文本  
        char: 多音字
        position: 位置
    
    Returns:
        拼音字符串（如 "zhang3"），或 None
    """
    return resolve_polyphone(text, char, position)


def is_polyphone(char: str) -> bool:
    """
    判断是否是多音字
    
    Args:
        char: 单个汉字
    
    Returns:
        是否在多音字词典中
    """
    return char in POLYPHONE_RULES


def get_all_polyphones() -> List[str]:
    """
    获取所有多音字列表
    
    Returns:
        多音字列表
    """
    return list(POLYPHONE_RULES.keys())

